function t(t,e,n=-1){t.tokenStream.push({token:t.state,startIndex:t.startIndex,endIndex:e+n}),t.startIndex=e}function e(e){const n=e.split(""),s={startIndex:0,state:"TOKEN_INSTRUCTION",tokenStream:[]};for(let e=0;e<n.length;++e){switch(n[e]){case" ":if("TOKEN_WHITESPACE"===s.state)break;t(s,e),s.state="TOKEN_WHITESPACE";break;case":":s.state="TOKEN_LABEL";break;case"\n":s.startIndex!==e&&t(s,e),s.state="TOKEN_NEWLINE",t(s,e,0),s.state="TOKEN_INSTRUCTION",s.startIndex=e+1;break;case"%":"TOKEN_WHITESPACE"===s.state&&(t(s,e),s.state="TOKEN_REGISTER");break;case",":t(s,e),s.state="TOKEN_COMMA";break;case"/":if(s.startIndex!==e&&t(s,e),"/"!==n[e+1]){s.state="TOKEN_INVALID";break}for(;"\n"!==n[e];)e++;s.state="TOKEN_COMMENT",--e;break;default:"TOKEN_WHITESPACE"===s.state&&(t(s,e),s.state="TOKEN_CONST")}}return t(s,n.length-1,0),s.tokenStream}function n(t,e){return e.programText.slice(t.startIndex,t.endIndex+1)}function s(t){console.error(t),process.exit(1)}function r(t){switch(t){case"%ra":return 0;case"%rb":return 1;case"%rc":return 2;case"%rd":return 3;default:s("Register is not known: "+t)}}const o={push:t=>{const[,e]=t.line;return[1,parseInt(n(e,t))]},load:t=>{const[,e]=t.line;return[4,r(n(e,t))]},log:t=>{const[,e]=t.line;return[2,r(n(e,t))]},inc:t=>{const[,e,s]=t.line;return[5,r(n(e,t)),parseInt(n(s,t))]},jl:t=>{const[,e]=t.line;return[8,n(e,t)]},halt:t=>[0]};function i(t){const[e]=t.line;if("TOKEN_INSTRUCTION"===e.token){const r=n(e,t);r in o?t.result.push(...o[r](t)):s(`Instruction not recognised: ${r}. location: ${e.startIndex}`),t.line=[]}else if("TOKEN_LABEL"===e.token){const s=n(e,t).slice(0,-1);t.labelMap.set(s,t.result.length),t.result.push(9),t.line=[]}else"TOKEN_COMMENT"!==e.token&&s(`Line needs to start with Instruction or Comment code: ${e}. location: ${e.startIndex}`);return t}function c(t){let n={result:[],line:[],labelMap:new Map,programText:t};const r=e(t),o=["TOKEN_WHITESPACE","TOKEN_COMMENT","TOKEN_COMMA"];for(const t of r)o.includes(t.token)||("TOKEN_NEWLINE"===t.token?0!==n.line.length&&(n=i(n)):n.line.push(t));return n.line.length>0&&(n=i(n)),n=function(t){for(let e=0;e<t.result.length;e++)if("string"==typeof t.result[e]){const n=t.labelMap.get(t.result[e]);n||s("Label not found. labelk: "+t.result[e]),t.result[e]=n}return t}(n),Int32Array.from(n.result)}function d(t){const e=t.nextInstruction();t.instructionIndex=e}const a={0:function(t){console.log("halt")},1:function(t){t.stack.push(t.nextInstruction())},2:function(t){t.stdOut(t.registers[t.nextInstruction()])},3:function(t){t.registers[0]=t.nextInstruction(),t.registers[1]=t.nextInstruction(),t.registers[2]=t.registers[0]+t.registers[1]},4:function(t){const e=t.stack.pop();t.registers[t.nextInstruction()]=e},5:function(t){t.registers[t.nextInstruction()]+=t.nextInstruction()},6:d,7:function(t){t.registers[2]>t.registers[3]?t.instructionIndex++:d(t)},8:function(t){t.registers[2]>=t.registers[3]?t.instructionIndex++:d(t)},10:function(t){return null},9:function(t){return null}};class l{constructor(t,e=null){this.stdOut=console.log,this.stack=[],this.registers=new Int32Array(4),this.instructionIndex=0,this.instructions=t,null!==e&&(this.stdOut=e)}nextInstruction(){return this.instructions[this.instructionIndex++]}}class u{constructor(t,e=null){this.vmState=new l(t,e)}run(){let t;do{t=this.vmState.instructions[this.vmState.instructionIndex++],a[t](this.vmState)}while(0!==t);return 0}}const I={TOKEN_INSTRUCTION:"instruction",TOKEN_CONST:"const",TOKEN_REGISTER:"register",TOKEN_COMMENT:"comment"};function x(t,n){const s=e(t);for(;n.firstChild;)n.removeChild(n.firstChild);let r,o=1;const i=[];for(const e of s){r||(i.push(f("line-number",o+":",e.startIndex,e.startIndex)),r=E("line"),r.dataset.startIndex=e.startIndex.toString(),o++);const n=I[e.token];if(n)r.appendChild(f(n,t.slice(e.startIndex,e.endIndex+1).replace(/\s/g," "),e.startIndex,e.endIndex));else switch(e.token){case"TOKEN_NEWLINE":r.dataset.endIndex=e.endIndex.toString(),i.push(r),r=null;break;case"TOKEN_WHITESPACE":r.appendChild(f(n,new Array(e.endIndex-e.startIndex+2).join(" "),e.startIndex,e.endIndex));break;default:r.appendChild(f("not-found",t.slice(e.startIndex,e.endIndex+1),e.startIndex,e.endIndex))}}r&&(r.dataset.endIndex=s[s.length-1].endIndex.toString(),i.push(r)),i.length>0&&n.append(...i)}function f(t,e,n,s){const r=document.createElement("span");return r.classList.add(t),r.textContent=e,r.dataset.startIndex=n.toString(),r.dataset.endIndex=s.toString(),r}function E(t){const e=document.createElement("div");return e.classList.add(t),e}let h,p,g,T,m,N=0,k=0,O=0,C=0,S=0,y=0,_=!0,K="push 10\nload %rd\nlog %rd\nloop_start:\ninc %rc, 1\nlog %rc\njl loop_start\nhalt";function L(t){t?p.classList.add("focused"):p.classList.remove("focused"),_=t}var M;function b(t){return w(t)}function w(t){const e=h.children[2*t+1];if(e)return{startIndex:parseInt(e.dataset.startIndex),endIndex:parseInt(e.dataset.endIndex)}}function A(){return h.children.length/2}function v(){return h.querySelector(".line-number").scrollWidth}function R(){const t=v();g.style.top=S+C*k+"px",g.style.left=y+t-N/2+O*N+"px"}M=()=>{h=document.getElementById("editor"),p=document.querySelector(".editor-panel"),g=document.querySelector(".cursor"),T=document.getElementById("control-run"),m=document.getElementById("console");const t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--editor-font-size"));N=.6*t,k=1.25*t,T.addEventListener("click",(t=>{for(;m.firstChild;)m.removeChild(m.firstChild);const e=new u(c(K),(t=>{const e=document.createElement("span");e.textContent=t.toString(),m.append(e)}));try{e.run()}catch(t){const e=document.createElement("span");e.textContent="Error: "+t,m.append(e)}})),document.addEventListener("click",(t=>{if(!function(t,e){if(null===t.target||!(t.target instanceof HTMLElement))return!1;let n=t.target;do{if(n===e)return!0;n=n.parentElement}while(null!==n);return!1}(t,p))return void L(!1);L(!0);const{clientX:e,clientY:n}=t,s=v();O=Math.floor((e-y-s)/N),C=Math.floor((n-S)/k),O=O>0?O:0,C=C>0?C:0;const r=w(C);if(r){const t=r.endIndex-r.startIndex;O=O<t?O:t}else{const t=b(h.children.length/2-1);C=h.children.length/2-1,O=t.endIndex-t.startIndex+1}R()})),document.addEventListener("keydown",(t=>{if(!_)return!1;"F5"!==t.key&&t.preventDefault();let e=!1;if(1===t.key.length){const n=" "!==t.key?t.key:" ",s=b(C);K=K.slice(0,O+s.startIndex)+n+K.slice(O+s.startIndex),O++,e=!0}else if("Backspace"===t.key){const t=b(C);if(O>0)K=K.slice(0,O+t.startIndex-1)+K.slice(O+t.startIndex),O--;else if(C>0){const e=b(C-1);K=K.slice(0,O+t.startIndex-1)+K.slice(O+t.startIndex),O=e.endIndex-e.startIndex,C--}e=!0}else if("Delete"===t.key){const t=b(C);K=K.slice(0,O+t.startIndex)+K.slice(O+t.startIndex+1),e=!0}else if("Enter"===t.key){const t=K.split("\n"),n=t[C];t[C]=n.slice(0,O)+"\n"+n.slice(O),K=t.join("\n"),C++,O=0,e=!0}else if("ArrowRight"===t.key){const t=b(C);if(O<t.endIndex-t.startIndex)O++;else{const e=A();C<e-1?(O=0,C++):O=t.endIndex-t.startIndex+1}}else if("ArrowLeft"===t.key){if(O>0)O--;else if(C>0){const t=b(C-1);O=t.endIndex-t.startIndex,C--}}else if("ArrowDown"===t.key){const t=A();if(C<t-1){const t=b(++C);O>t.endIndex-t.startIndex&&(O=t.endIndex-t.startIndex)}else{const t=b(C);O=t.endIndex-t.startIndex+1}}else if("ArrowUp"===t.key)if(C>0){const t=b(--C);O>t.endIndex-t.startIndex&&(O=t.endIndex-t.startIndex)}else O=0;console.log(t.key),R(),e&&x(K,h)})),setTimeout((()=>{S=h.offsetTop,y=h.offsetLeft,x(K,h),R(),L(!0)}),500)},"complete"===document.readyState||"interactive"===document.readyState?setTimeout(M,1):document.addEventListener("DOMContentLoaded",M);
