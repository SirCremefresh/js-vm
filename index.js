function e(e,t,n=-1){e.tokenStream.push({token:e.state,startIndex:e.startIndex,endIndex:t+n}),e.startIndex=t}const t={TOKEN_INSTRUCTION:"instruction",TOKEN_CONST:"const",TOKEN_REGISTER:"register",TOKEN_COMMENT:"comment"};function n(n,r){const a=function(t){const n=t.split(""),s={startIndex:0,state:"TOKEN_INSTRUCTION",tokenStream:[]};for(let t=0;t<n.length;++t)switch(n[t]){case" ":if("TOKEN_WHITESPACE"===s.state)break;e(s,t),s.state="TOKEN_WHITESPACE";break;case":":s.state="TOKEN_LABEL";break;case"\n":s.startIndex!==t&&e(s,t),s.state="TOKEN_NEWLINE",e(s,t,0),s.state="TOKEN_INSTRUCTION",s.startIndex=t+1;break;case"%":"TOKEN_WHITESPACE"===s.state&&(e(s,t),s.state="TOKEN_REGISTER");break;case",":e(s,t),s.state="TOKEN_COMMA";break;case"/":if(s.startIndex!==t&&e(s,t),"/"!==n[t+1]){s.state="TOKEN_INVALID";break}for(;"\n"!==n[t];)t++;s.state="TOKEN_COMMENT",--t;break;default:"TOKEN_WHITESPACE"===s.state&&(e(s,t),s.state="TOKEN_CONST")}return e(s,n.length-1,0),s.tokenStream}(n);for(;r.firstChild;)r.removeChild(r.firstChild);let o,c=1;const l=[];for(const e of a){o||(l.push(s("line-number",c+":",e.startIndex,e.startIndex)),o=d("line"),o.dataset.startIndex=e.startIndex.toString(),c++);const r=t[e.token];if(r)o.appendChild(s(r,n.slice(e.startIndex,e.endIndex+1).replace(/\s/g," "),e.startIndex,e.endIndex));else switch(e.token){case"TOKEN_NEWLINE":o.dataset.endIndex=e.endIndex.toString(),l.push(o),o=null;break;case"TOKEN_WHITESPACE":o.appendChild(s(r,new Array(e.endIndex-e.startIndex+2).join(" "),e.startIndex,e.endIndex));break;default:o.appendChild(s("not-found",n.slice(e.startIndex,e.endIndex+1),e.startIndex,e.endIndex))}}o&&(o.dataset.endIndex=a[a.length-1].endIndex.toString(),l.push(o)),l.length>0&&r.append(...l),console.timeEnd("render")}function s(e,t,n,s){const d=document.createElement("span");return d.classList.add(e),d.textContent=t,d.dataset.startIndex=n.toString(),d.dataset.endIndex=s.toString(),d}function d(e){const t=document.createElement("div");return t.classList.add(e),t}let r,a,o,c=0,l=0,i=0,I=0,x=0,f=0,u=!0,E="push 100\nload %rd\nlog %rd\nloop_start:\ninc %rc, 1\nlog %rc\njl loop_start\nhalt";function T(e){e?a.classList.add("focused"):a.classList.remove("focused"),u=e}var p;function N(e){return h(e)}function h(e){const t=r.children[2*e+1];if(t)return{startIndex:parseInt(t.dataset.startIndex),endIndex:parseInt(t.dataset.endIndex)}}function m(){return r.children.length/2}function k(){return r.querySelector(".line-number").scrollWidth}function g(){const e=k();console.log(e,f),o.style.top=x+I*l+"px",o.style.left=f+e-c/2+i*c+"px"}p=()=>{r=document.getElementById("editor"),a=document.querySelector(".editor-panel"),o=document.querySelector(".cursor");const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--editor-font-size"));c=.6*e,l=1.25*e,console.log({fontSize:e,fontLength:c,fontHeight:l}),document.addEventListener("click",(e=>{if(!function(e,t){if(null===e.target||!(e.target instanceof HTMLElement))return!1;let n=e.target;do{if(n===t)return!0;n=n.parentElement}while(null!==n);return!1}(e,a))return void T(!1);T(!0);const{clientX:t,clientY:n}=e,s=k();i=Math.floor((t-f-s)/c),I=Math.floor((n-x)/l),i=i>0?i:0,I=I>0?I:0;const d=h(I);if(d){const e=d.endIndex-d.startIndex;i=i<e?i:e}else{const e=N(r.children.length/2-1);I=r.children.length/2-1,i=e.endIndex-e.startIndex+1}g()})),document.addEventListener("keydown",(e=>{if(!u)return!1;"F5"!==e.key&&e.preventDefault();let t=!1;if(1===e.key.length){const n=" "!==e.key?e.key:" ",s=N(I);E=E.slice(0,i+s.startIndex)+n+E.slice(i+s.startIndex),i++,t=!0}else if("Backspace"===e.key){const e=N(I);if(i>0)E=E.slice(0,i+e.startIndex-1)+E.slice(i+e.startIndex),i--;else if(I>0){const t=N(I-1);E=E.slice(0,i+e.startIndex-1)+E.slice(i+e.startIndex),i=t.endIndex-t.startIndex,I--}t=!0}else if("Delete"===e.key){const e=N(I);E=E.slice(0,i+e.startIndex)+E.slice(i+e.startIndex+1),t=!0}else if("Enter"===e.key){const e=E.split("\n"),n=e[I];e[I]=n.slice(0,i)+"\n"+n.slice(i),E=e.join("\n"),I++,i=0,t=!0}else if("ArrowRight"===e.key){const e=N(I);if(i<e.endIndex-e.startIndex)i++;else{const t=m();I<t-1?(i=0,I++):i=e.endIndex-e.startIndex+1}}else if("ArrowLeft"===e.key){if(i>0)i--;else if(I>0){const e=N(I-1);i=e.endIndex-e.startIndex,I--}}else if("ArrowDown"===e.key){const e=m();if(I<e-1){const e=N(++I);i>e.endIndex-e.startIndex&&(i=e.endIndex-e.startIndex)}else{const e=N(I);i=e.endIndex-e.startIndex+1}}else if("ArrowUp"===e.key)if(I>0){const e=N(--I);i>e.endIndex-e.startIndex&&(i=e.endIndex-e.startIndex)}else i=0;console.log(e.key),g(),t&&n(E,r)})),setTimeout((()=>{x=r.offsetTop,f=r.offsetLeft,n(E,r),g(),T(!0)}),500)},"complete"===document.readyState||"interactive"===document.readyState?setTimeout(p,1):document.addEventListener("DOMContentLoaded",p);
