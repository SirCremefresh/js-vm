function e(e,t,n=-1){e.tokenStream.push({token:e.state,startIndex:e.startIndex,endIndex:t+n}),e.startIndex=t}const t={TOKEN_INSTRUCTION:"instruction",TOKEN_CONST:"const",TOKEN_REGISTER:"register",TOKEN_COMMENT:"comment"};function n(n,r){const a=function(t){const n=t.split(""),s={startIndex:0,state:"TOKEN_INSTRUCTION",tokenStream:[]};for(let t=0;t<n.length;++t)switch(n[t]){case" ":if("TOKEN_WHITESPACE"===s.state)break;e(s,t),s.state="TOKEN_WHITESPACE";break;case":":s.state="TOKEN_LABEL";break;case"\n":s.startIndex!==t&&e(s,t),s.state="TOKEN_NEWLINE",e(s,t,0),s.state="TOKEN_INSTRUCTION",s.startIndex=t+1;break;case"%":"TOKEN_WHITESPACE"===s.state&&(e(s,t),s.state="TOKEN_REGISTER");break;case",":e(s,t),s.state="TOKEN_COMMA";break;case"/":if(s.startIndex!==t&&e(s,t),"/"!==n[t+1]){s.state="TOKEN_INVALID";break}for(;"\n"!==n[t];)t++;s.state="TOKEN_COMMENT",--t;break;default:"TOKEN_WHITESPACE"===s.state&&(e(s,t),s.state="TOKEN_CONST")}return e(s,n.length-1,0),s.tokenStream}(n);for(;r.firstChild;)r.removeChild(r.firstChild);let o,l=1;const c=[];for(const e of a){o||(c.push(s("line-number",l+":",e.startIndex,e.startIndex)),o=d("line"),o.dataset.startIndex=e.startIndex.toString(),l++);const r=t[e.token];if(r)o.appendChild(s(r,n.slice(e.startIndex,e.endIndex+1).replace(/\s/g," "),e.startIndex,e.endIndex));else switch(e.token){case"TOKEN_NEWLINE":o.dataset.endIndex=e.endIndex.toString(),c.push(o),o=null;break;case"TOKEN_WHITESPACE":o.appendChild(s(r,new Array(e.endIndex-e.startIndex+2).join(" "),e.startIndex,e.endIndex));break;default:o.appendChild(s("not-found",n.slice(e.startIndex,e.endIndex+1),e.startIndex,e.endIndex))}}o&&(o.dataset.endIndex=a[a.length-1].endIndex.toString(),c.push(o)),c.length>0&&r.append(...c),console.timeEnd("render")}function s(e,t,n,s){const d=document.createElement("span");return d.classList.add(e),d.textContent=t,d.dataset.startIndex=n.toString(),d.dataset.endIndex=s.toString(),d}function d(e){const t=document.createElement("div");return t.classList.add(e),t}let r,a,o,l=0,c=0,i=0,I=0,x=0,f=0,u="push 100\nload %rd\nlog %rd\nloop_start:\ninc %rc, 1\nlog %rc\njl loop_start\nhalt";var E;function T(e){return p(e)}function p(e){const t=r.children[2*e+1];if(t)return{startIndex:parseInt(t.dataset.startIndex),endIndex:parseInt(t.dataset.endIndex)}}function N(){return r.children.length/2}function h(){return r.querySelector(".line-number").scrollWidth}function k(){const e=h();console.log(e,f),o.style.top=x+I*c+"px",o.style.left=f+e-l/2+i*l+"px"}E=()=>{r=document.getElementById("editor"),a=document.querySelector(".editor-panel"),o=document.querySelector(".cursor");const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--editor-font-size"));l=.6*e,c=1.25*e,console.log({fontSize:e,fontLength:l,fontHeight:c}),document.addEventListener("click",(e=>{if(!function(e,t){if(null===e.target||!(e.target instanceof HTMLElement))return!1;let n=e.target;do{if(n===t)return!0;n=n.parentElement}while(null!==n);return!1}(e,a))return;const{clientX:t,clientY:n}=e,s=h();i=Math.floor((t-f-s)/l),I=Math.floor((n-x)/c),i=i>0?i:0,I=I>0?I:0;const d=p(I);if(d){const e=d.endIndex-d.startIndex;i=i<e?i:e}else{const e=T(r.children.length/2-1);I=r.children.length/2-1,i=e.endIndex-e.startIndex+1}k()})),document.addEventListener("keydown",(e=>{"F5"!==e.key&&e.preventDefault();let t=!1;if(1===e.key.length){const n=" "!==e.key?e.key:" ",s=T(I);u=u.slice(0,i+s.startIndex)+n+u.slice(i+s.startIndex),i++,t=!0}else if("Backspace"===e.key){const e=T(I);if(i>0)u=u.slice(0,i+e.startIndex-1)+u.slice(i+e.startIndex),i--;else if(I>0){const t=T(I-1);u=u.slice(0,i+e.startIndex-1)+u.slice(i+e.startIndex),i=t.endIndex-t.startIndex,I--}t=!0}else if("Delete"===e.key){const e=T(I);u=u.slice(0,i+e.startIndex)+u.slice(i+e.startIndex+1),t=!0}else if("Enter"===e.key){const e=u.split("\n"),n=e[I];e[I]=n.slice(0,i)+"\n"+n.slice(i),u=e.join("\n"),I++,i=0,t=!0}else if("ArrowRight"===e.key){const e=T(I);if(i<e.endIndex-e.startIndex)i++;else{const t=N();I<t-1?(i=0,I++):i=e.endIndex-e.startIndex+1}}else if("ArrowLeft"===e.key){if(i>0)i--;else if(I>0){const e=T(I-1);i=e.endIndex-e.startIndex,I--}}else if("ArrowDown"===e.key){const e=N();if(I<e-1){const e=T(++I);i>e.endIndex-e.startIndex&&(i=e.endIndex-e.startIndex)}else{const e=T(I);i=e.endIndex-e.startIndex+1}}else if("ArrowUp"===e.key)if(I>0){const e=T(--I);i>e.endIndex-e.startIndex&&(i=e.endIndex-e.startIndex)}else i=0;console.log(e.key),k(),t&&n(u,r)})),setTimeout((()=>{x=r.offsetTop,f=r.offsetLeft,n(u,r),k()}),500),console.log("after")},"complete"===document.readyState||"interactive"===document.readyState?setTimeout(E,1):document.addEventListener("DOMContentLoaded",E);
